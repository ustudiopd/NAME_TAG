# 현시점 문제 리포트 (2025-01-27)

## 📋 개요

콘솔 로그 분석 결과, 두 가지 주요 문제가 확인되었습니다:
1. **배경 이미지 모달이 열리지 않는 문제**
2. **이름 텍스트 중복 문제**

## 🔍 문제 1: 배경 이미지 모달이 열리지 않음

### 증상
- 배경 이미지 버튼 클릭 시 콘솔에 "Background image button clicked in CanvasViewport" 로그는 출력됨
- 하지만 모달이 화면에 표시되지 않음
- 추가로 "EventDetailView.js:110 Background image upload" 로그가 출력됨

### 원인 분석

#### 1. 구버전 컴포넌트가 여전히 사용되고 있음
```
EventDetailView.js:110 Background image upload
```
- 이 로그는 **구버전 `EventDetailView.js`**의 핸들러에서 출력됨
- `EventDetailView_new.js`가 아닌 `EventDetailView.js`가 실제로 렌더링되고 있음
- 구버전의 `handleBackgroundImage`는 단순히 `console.log`만 출력하고 모달을 열지 않음

**구버전 코드 (EventDetailView.js:108-111):**
```javascript
const handleBackgroundImage = () => {
  // TODO: 이미지 업로드 UI 구현
  console.log('Background image upload')
}
```

#### 2. 컴포넌트 라우팅 문제
- 앱의 라우팅에서 `EventDetailView.js` (구버전)를 사용하고 있을 가능성
- `EventDetailView_new.js`가 제대로 import되지 않았을 가능성

#### 3. 상태 관리 문제 (가능성 낮음)
- `EventDetailView_new.js`의 `showBackgroundImageModal` 상태가 제대로 업데이트되지 않을 수 있음
- 하지만 로그상 구버전이 호출되고 있으므로 이 문제는 부차적

### 해결 방안

#### 즉시 조치
1. **라우팅 파일 확인 및 수정**
   - `app/events/[id]/page.js` 또는 해당 라우팅 파일에서
   - `EventDetailView` import 경로 확인
   - `EventDetailView_new.js`를 사용하도록 변경

2. **구버전 파일 확인**
   - `components/EventDetailView.js`가 여전히 사용되는지 확인
   - 사용 중이면 `EventDetailView_new.js`로 교체

#### 코드 수정 예시
```javascript
// ❌ 잘못된 import
import EventDetailView from '../components/EventDetailView'

// ✅ 올바른 import
import EventDetailView from '../components/EventDetailView_new'
```

---

## 🔍 문제 2: 이름 텍스트 중복 (2개 겹쳐서 표시)

### 증상
- 편집 화면에서 이름 텍스트가 2개 겹쳐서 표시됨
- 콘솔 로그: "Template loaded successfully with 6 objects, 6 text objects"
- 템플릿 로드 시 텍스트 객체가 중복 생성됨

### 원인 분석

#### 1. 템플릿 로드 시 중복 생성
```
EditorCore.js:790 Template loaded successfully with 6 objects, 6 text objects
```
- 템플릿에 이미 텍스트 객체가 6개 포함되어 있음
- `loadTemplate()` 후 `createDefaultTemplate()`이 호출되면 중복 생성됨

#### 2. `createDefaultTemplate()` 중복 호출
- `useNamecardEditor.js`의 `loadEventLayout` 함수에서
- 여러 경로에서 `createDefaultTemplate()`이 호출될 수 있음:
  ```javascript
  // 경로 1: EventLayout이 없을 때
  core.createDefaultTemplate()
  
  // 경로 2: DefaultTemplate이 없을 때
  core.createDefaultTemplate()
  
  // 경로 3: 에러 발생 시
  core.createDefaultTemplate()
  ```

#### 3. `bindProfile()`의 중복 제거 로직 한계
- `bindProfile()`에서 중복 제거를 시도하지만
- 이미 템플릿에 중복이 포함되어 있으면 제거되지 않음
- `createDefaultTemplate()`에서 중복 체크를 하지만, 템플릿 로드 후에는 작동하지 않음

#### 4. 템플릿 로드 로직 문제
**현재 `loadTemplate()` 로직:**
```javascript
async loadTemplate(canvasJson) {
  this.canvas.clear()  // 기존 객체 제거
  this.canvas.loadFromJSON(canvasJson, () => {
    // 템플릿이 빈 객체이거나 텍스트 객체가 없으면 기본 템플릿 생성
    if (!hasTextObjects) {
      this.createDefaultTemplate()  // ⚠️ 여기서 중복 생성 가능
    }
  })
}
```

**문제점:**
- 템플릿에 텍스트 객체가 있으면 `createDefaultTemplate()`이 호출되지 않음
- 하지만 템플릿 자체에 중복이 포함되어 있을 수 있음
- `loadTemplate()` 후 중복 체크가 없음

### 해결 방안

#### 1. `loadTemplate()` 후 중복 제거 로직 추가
```javascript
async loadTemplate(canvasJson) {
  // ... 기존 코드 ...
  
  this.canvas.loadFromJSON(canvasJson, () => {
    // ... 배경 이미지 처리 ...
    
    // 템플릿 로드 후 중복 제거
    this.removeDuplicateTextObjects()
    
    // 텍스트 객체가 없으면 기본 템플릿 생성
    if (!hasTextObjects) {
      this.createDefaultTemplate()
    }
  })
}

removeDuplicateTextObjects() {
  const objects = this.canvas.getObjects()
  const textObjects = objects.filter(obj => 
    (obj.type === 'i-text' || obj.type === 'text' || obj.type === 'textbox') && 
    obj.dataField
  )
  
  const fieldMap = new Map()
  textObjects.forEach(obj => {
    const dataField = obj.dataField
    if (fieldMap.has(dataField)) {
      // 중복 제거
      this.canvas.remove(obj)
      console.log(`Removing duplicate text object: ${dataField}`)
    } else {
      fieldMap.set(dataField, obj)
    }
  })
  
  this.canvas.renderAll()
}
```

#### 2. `createDefaultTemplate()` 호출 조건 강화
- 템플릿 로드 후에는 `createDefaultTemplate()` 호출 방지
- 텍스트 객체가 정말 없을 때만 호출

#### 3. `bindProfile()` 호출 시점 조정
- 템플릿 로드 직후 `bindProfile()` 호출
- 중복 제거 로직이 실행되도록 보장

---

## 📊 현재 코드 상태

### 사용 중인 컴포넌트
- ❌ `components/EventDetailView.js` (구버전) - **여전히 사용 중**
- ✅ `components/EventDetailView_new.js` (신버전) - **구현 완료, 미사용**

### 핸들러 상태
- ❌ `EventDetailView.js:108` - `handleBackgroundImage()` - 모달 열기 미구현
- ✅ `EventDetailView_new.js:133` - `handleBackgroundImage()` - 모달 열기 구현됨

### 중복 제거 로직
- ✅ `EditorCore.bindProfile()` - 중복 제거 로직 있음
- ✅ `EditorCore.createDefaultTemplate()` - 중복 체크 로직 있음
- ❌ `EditorCore.loadTemplate()` - 중복 제거 로직 없음

---

## 🎯 우선순위별 해결 방안

### 🔴 High (즉시 조치)
1. **라우팅 파일에서 `EventDetailView_new.js` 사용 확인**
   - `app/events/[id]/page.js` 확인
   - import 경로 수정

2. **템플릿 로드 후 중복 제거 로직 추가**
   - `EditorCore.loadTemplate()`에 `removeDuplicateTextObjects()` 호출 추가

### 🟡 Medium (단기 조치)
3. **구버전 파일 정리**
   - `EventDetailView.js` 사용 여부 확인
   - 사용 중이면 신버전으로 교체

4. **중복 제거 로직 통합**
   - `removeDuplicateTextObjects()` 메서드 추가
   - 여러 곳에서 재사용 가능하도록

### 🟢 Low (장기 개선)
5. **로깅 개선**
   - 중복 제거 시 상세 로그 출력
   - 디버깅 용이성 향상

---

## 🔧 수정이 필요한 파일

1. **라우팅 파일** (확인 필요)
   - `app/events/[id]/page.js` 또는 해당 라우팅 파일

2. **EditorCore.js**
   - `loadTemplate()` 메서드에 중복 제거 로직 추가
   - `removeDuplicateTextObjects()` 메서드 추가

3. **EventDetailView.js** (구버전)
   - 사용 중이면 제거 또는 신버전으로 교체

---

## 📝 테스트 체크리스트

### 배경 이미지 모달
- [ ] 배경 이미지 버튼 클릭 시 모달이 열리는지 확인
- [ ] 모달이 화면 중앙에 표시되는지 확인
- [ ] 모달 배경 클릭 시 닫히는지 확인
- [ ] 이미지 선택 시 모달이 닫히는지 확인

### 이름 중복
- [ ] 템플릿 로드 후 텍스트 객체가 중복되지 않는지 확인
- [ ] 프로필 변경 시 텍스트가 중복되지 않는지 확인
- [ ] 기본 템플릿 생성 시 텍스트가 중복되지 않는지 확인
- [ ] 콘솔에 "Removing duplicate text object" 로그가 출력되는지 확인

---

## 🚨 추가 확인 사항

1. **컴포넌트 import 경로**
   - 현재 어떤 파일에서 `EventDetailView`를 import하는지 확인
   - `EventDetailView_new.js`를 사용하도록 변경

2. **템플릿 데이터**
   - DB에 저장된 템플릿에 중복이 포함되어 있는지 확인
   - 템플릿 마이그레이션 필요 여부 확인

3. **프로필 바인딩 타이밍**
   - 템플릿 로드 후 프로필 바인딩이 언제 호출되는지 확인
   - 중복 제거가 프로필 바인딩 전에 실행되는지 확인

---

**리포트 작성일**: 2025-01-27  
**분석 기준**: 콘솔 로그 및 코드 검토  
**상태**: 문제 원인 파악 완료, 해결 방안 제시

