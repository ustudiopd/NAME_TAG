# 400 에러 수정 완료

## 문제점
`event_layouts` 저장 시 400 에러 반복 발생

## 원인 분석

1. **upsert의 onConflict 문제**:
   - `onConflict: 'event_id'` 사용 시 Supabase PostgREST가 제약조건을 제대로 인식하지 못할 수 있음
   - 실제 제약조건 이름은 `event_layouts_event_id_key`이지만, 컬럼 이름으로 지정해야 함

2. **데이터 타입 불일치**:
   - `paper_width_cm`, `paper_height_cm`가 `numeric` 타입인데 JavaScript 숫자 변환 필요
   - `canvas_json`이 유효한 객체인지 확인 필요

3. **updated_at 수동 설정**:
   - DB에 트리거가 있어 자동으로 처리되므로 수동 설정 불필요

4. **에러 정보 부족**:
   - 400 에러의 구체적인 원인 파악이 어려움

## 수정 내용

### `lib/repositories/EventLayoutRepository.js` - `saveEventLayout()` 개선

1. **upsert 대신 insert/update 분리**:
   - 먼저 기존 레이아웃 존재 여부 확인
   - 있으면 `update`, 없으면 `insert` 사용
   - 더 안전하고 예측 가능한 동작

2. **데이터 검증 및 정규화**:
   - `eventId` 필수 검증
   - `canvas_json` 유효성 검사
   - `paper_width_cm`, `paper_height_cm`를 `parseFloat()`로 변환
   - `null` 값 처리 개선

3. **에러 로깅 개선**:
   - 상세한 에러 정보 로깅 (code, message, details, hint)
   - 디버깅을 위한 데이터 상태 로깅

4. **updated_at 제거**:
   - DB 트리거(`event_layouts_updated_at_trigger`)가 자동으로 처리
   - 수동 설정 제거

## 수정된 코드 구조

```javascript
// 1. 데이터 검증
if (!layout.eventId) throw new Error('eventId is required')

// 2. 데이터 정규화
const upsertData = {
  event_id: layout.eventId,
  template_id: layout.templateId || null,
  canvas_json: layout.canvasJson || {},
  paper_width_cm: parseFloat(layout.paperWidthCm) || 9.0,
  paper_height_cm: parseFloat(layout.paperHeightCm) || 12.5,
  // updated_at 제거 (트리거가 처리)
}

// 3. 기존 레이아웃 확인
const existing = await supabase
  .from('event_layouts')
  .select('id')
  .eq('event_id', layout.eventId)
  .maybeSingle()

// 4. insert 또는 update
if (existing) {
  // UPDATE
} else {
  // INSERT
}
```

## 예상 결과

1. **400 에러 해결**:
   - 데이터 검증 및 정규화로 잘못된 요청 방지
   - insert/update 분리로 더 안전한 처리

2. **에러 디버깅 개선**:
   - 상세한 에러 로그로 문제 파악 용이

3. **안정성 향상**:
   - 데이터 타입 변환으로 DB 스키마와 일치
   - null 값 처리 개선

## 테스트 방법

1. 브라우저 강력 새로고침 (Ctrl+F5)
2. 편집 화면에서 객체 이동/수정
3. 콘솔 확인:
   - "Saving event layout:" 로그 확인
   - 400 에러가 발생하지 않는지 확인
   - 저장 성공 메시지 확인
4. 네트워크 탭 확인:
   - `event_layouts` 요청이 성공(200)하는지 확인

---

**수정 완료일**: 2025-01-27  
**수정된 파일**: `lib/repositories/EventLayoutRepository.js`

