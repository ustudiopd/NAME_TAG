# 명찰 출력 프로그램 - 템플릿 JSON 교체 문제점 분석 리포트

## 📋 현재 상황 요약

**문제**: 템플릿 불러오기 시 캔버스가 기본설정으로만 초기화되고, 템플릿의 JSON 데이터가 제대로 반영되지 않음

**영향**: 사용자가 저장한 템플릿을 불러와도 원래 디자인이 복원되지 않아 템플릿 기능이 실질적으로 작동하지 않음

---

## 🏗️ 프로젝트 구조

### 주요 컴포넌트 파일
```
components/
├── CanvasEditor.js              # 기본 캔버스 에디터 (936줄)
├── CanvasEditor_new.js          # 고급 캔버스 에디터 (1054줄) ← 현재 사용 중
├── CanvasEditor_backup.js       # 백업 파일
├── CanvasEditor_fixed.js        # 수정된 버전
├── EventDetailView.js           # 이벤트 상세 뷰 (템플릿 로드 호출)
├── NamecardTemplateManager.js   # 템플릿 관리 컴포넌트
├── NamecardTemplateSettings.js  # 템플릿 설정 컴포넌트
└── PropertyPanel.js             # 속성 패널
```

### 데이터베이스 관련 파일
```
lib/
├── namecardDatabase.js          # 템플릿 CRUD 함수들
├── supabaseClient.js           # Supabase 연결
└── storage.js                  # 이미지 저장
```

### 메모리 뱅크
```
memory_bank/
├── projectbrief.md             # 프로젝트 개요
├── techContext.md              # 기술 스택 정보
├── systemPatterns.md           # 아키텍처 패턴
├── productContext.md           # 비즈니스 로직
└── progress.md                 # 진행 상황
```

---

## 🔍 문제점 상세 분석

### 1. **템플릿 로드 플로우 문제**

#### 현재 플로우:
```
EventDetailView.js 
  → handleTemplateSelect(template)
  → canvasRef.loadTemplate(template)
  → CanvasEditor_new.js loadTemplate()
  → loadOptimizedTemplate() 또는 loadFromJSON()
```

#### 문제점:
- **템플릿 데이터 구조 불일치**: 저장된 JSON과 로드 시 기대하는 구조가 다름
- **에러 처리 부족**: JSON 파싱 실패 시 기본 템플릿으로 대체되어 문제가 숨겨짐
- **비동기 처리 문제**: 이미지 로드 등 비동기 작업의 완료를 기다리지 않음

### 2. **JSON 데이터 구조 문제**

#### 저장되는 JSON 구조 (namecardDatabase.js):
```javascript
{
  event_id: eventId,
  template_name: templateName,
  canvas_json: canvasJson,  // ← 실제 캔버스 JSON이 여기에 저장됨
  is_default: false,
  // ... 기타 메타데이터
}
```

#### 로드 시 기대하는 구조 (CanvasEditor_new.js):
```javascript
// loadOptimizedTemplate에서 기대하는 구조
if (templateData.version === '1.0') {
  // 최적화된 JSON 처리
  loadOptimizedTemplate(canvas, templateData)
} else {
  // 기존 Fabric.js JSON 처리
  canvas.loadFromJSON(jsonData, ...)
}
```

#### **핵심 문제**: 
- `template.canvas_json`이 실제 캔버스 JSON인데, `templateData`로 직접 사용
- `templateData.version`을 확인하지만 `template.canvas_json.version`을 확인해야 함

### 3. **코드 분석 결과**

#### EventDetailView.js (79-92줄):
```javascript
const handleTemplateSelect = (template) => {
  console.log('EventDetailView handleTemplateSelect called:', template)
  
  if (canvasRef.current) {
    // canvasRef.loadTemplate(template) 호출
    canvasRef.loadTemplate(template)
  } else {
    // 캔버스가 준비되지 않은 경우 대기
    setTimeout(() => {
      if (canvasRef.current) {
        canvasRef.loadTemplate(template)
      }
    }, 100)
  }
}
```

#### CanvasEditor_new.js loadTemplate() (454-525줄):
```javascript
const loadTemplate = (template) => {
  // ...
  if (!template.canvas_json) {
    console.error('Template JSON data not provided')
    return
  }
  
  const templateData = template.canvas_json  // ← 여기서 문제!
  
  // templateData.version을 확인하지만 실제로는 template.canvas_json.version을 확인해야 함
  if (templateData.version === '1.0') {
    loadOptimizedTemplate(canvas, templateData)
  } else {
    // 기존 Fabric.js JSON 처리
  }
}
```

---

## 🐛 구체적인 버그들

### 1. **JSON 구조 접근 오류**
```javascript
// 현재 (잘못된 코드)
const templateData = template.canvas_json
if (templateData.version === '1.0') { ... }

// 수정해야 할 코드
const templateData = template.canvas_json
if (templateData && templateData.version === '1.0') { ... }
```

### 2. **에러 처리 부족**
```javascript
// 현재: 에러 발생 시 기본 템플릿으로 대체
catch (error) {
  console.error('Error loading template:', error)
  createDefaultTemplate(canvas)  // ← 문제를 숨김
}

// 개선 필요: 에러를 사용자에게 알리고 디버깅 정보 제공
```

### 3. **비동기 처리 문제**
```javascript
// 이미지 로드가 완료되기 전에 renderAll() 호출
fabric.Image.fromURL(objData.src, (img) => {
  // ... 이미지 설정
  canvas.add(img)
  canvas.renderAll()  // ← 이미지가 완전히 로드되기 전에 렌더링
})
```

### 4. **디버깅 정보 부족**
- 콘솔 로그는 있지만 실제 JSON 구조를 확인할 수 없음
- 템플릿 로드 실패 시 구체적인 원인을 알 수 없음

---

## 🔧 해결 방안

### 1. **즉시 수정 필요**
```javascript
// CanvasEditor_new.js loadTemplate() 함수 수정
const loadTemplate = (template) => {
  console.log('Loading template:', template)
  console.log('Template canvas_json:', template.canvas_json)
  
  if (!template || !template.canvas_json) {
    console.error('Template or canvas_json not provided')
    return
  }
  
  const templateData = template.canvas_json
  
  // JSON 구조 검증 추가
  if (!templateData || typeof templateData !== 'object') {
    console.error('Invalid template JSON data:', templateData)
    return
  }
  
  // 버전 확인 수정
  if (templateData.version === '1.0') {
    loadOptimizedTemplate(canvas, templateData)
  } else {
    // 기존 Fabric.js JSON 처리
  }
}
```

### 2. **디버깅 강화**
```javascript
// JSON 구조를 콘솔에 출력
console.log('Template data structure:', {
  hasVersion: !!templateData.version,
  version: templateData.version,
  hasObjects: !!templateData.objects,
  objectCount: templateData.objects?.length || 0,
  hasCanvas: !!templateData.canvas
})
```

### 3. **에러 처리 개선**
```javascript
// 에러 발생 시 기본 템플릿 대신 에러 표시
catch (error) {
  console.error('Error loading template:', error)
  alert(`템플릿 로드 실패: ${error.message}`)
  // createDefaultTemplate(canvas) 제거
}
```

---

## 📊 연관 파일 및 의존성

### 직접 연관 파일
1. **components/CanvasEditor_new.js** - 메인 캔버스 에디터
2. **components/EventDetailView.js** - 템플릿 로드 호출
3. **components/NamecardTemplateManager.js** - 템플릿 관리
4. **lib/namecardDatabase.js** - 템플릿 저장/로드 함수

### 간접 연관 파일
1. **components/PropertyPanel.js** - 속성 패널 (템플릿 로드 후 연동)
2. **lib/supabaseClient.js** - 데이터베이스 연결
3. **memory_bank/progress.md** - 진행 상황 기록

### 데이터베이스 테이블
- **namecards** 테이블: 템플릿 데이터 저장
  - `canvas_json` 컬럼: 실제 캔버스 JSON 데이터
  - `template_name`: 템플릿 이름
  - `event_id`: 이벤트 ID

---

## 🎯 우선순위별 해결 계획

### 1단계: 즉시 수정 (High Priority)
- [ ] JSON 구조 접근 오류 수정
- [ ] 디버깅 로그 추가
- [ ] 에러 처리 개선

### 2단계: 기능 개선 (Medium Priority)
- [ ] 비동기 처리 개선
- [ ] 템플릿 검증 로직 추가
- [ ] 사용자 피드백 개선

### 3단계: 장기 개선 (Low Priority)
- [ ] 템플릿 버전 관리 시스템
- [ ] 자동 백업 기능
- [ ] 템플릿 미리보기 기능

---

## 📝 테스트 시나리오

### 1. **기본 템플릿 로드 테스트**
1. 템플릿 저장
2. 템플릿 불러오기
3. 캔버스에 객체들이 정확히 표시되는지 확인

### 2. **에러 상황 테스트**
1. 잘못된 JSON 구조의 템플릿 로드
2. 빈 템플릿 로드
3. 네트워크 오류 상황

### 3. **복합 시나리오 테스트**
1. 템플릿 저장 → 불러오기 → 수정 → 다시 저장
2. 여러 템플릿 간 전환
3. 이미지가 포함된 템플릿 로드

---

## 🔍 디버깅을 위한 추가 정보

### 현재 사용 중인 파일
- **메인 캔버스**: `components/CanvasEditor_new.js`
- **템플릿 로드 호출**: `components/EventDetailView.js`
- **데이터베이스**: `lib/namecardDatabase.js`

### 주요 함수들
- `loadTemplate()`: 템플릿 로드 메인 함수
- `loadOptimizedTemplate()`: 최적화된 JSON 처리
- `handleTemplateSelect()`: 템플릿 선택 핸들러
- `saveNamecardTemplate()`: 템플릿 저장 함수

### 콘솔 로그 키워드
- "Loading template:"
- "Template JSON loaded, rendering..."
- "Optimized template loaded successfully"
- "Error loading template:"

---

**작성일**: 2025년 1월 13일  
**작성자**: Cursor AI Assistant  
**프로젝트**: 명찰 출력 프로그램  
**상태**: 문제 분석 완료, 해결 방안 제시
