# 명찰 출력 프로그램 - 캔버스 렌더링 문제점 분석 리포트 (업데이트)

## 📋 현재 상황 요약 (2025-01-13 업데이트)

**주요 문제**: 배포 환경에서 캔버스가 화면에 표시되지 않는 문제
- **테스트 환경**: 정상 작동 (캔버스 표시, 프로필 업데이트, 출력 모두 정상)
- **배포 환경**: 캔버스가 화면에 렌더링되지 않음 (데이터는 정상 처리됨)

**영향**: 
1. 사용자가 웹에서 명찰을 편집할 수 없음
2. 출력 기능은 정상 작동 (데이터 처리 로직은 문제없음)
3. 템플릿 기능도 동일한 렌더링 문제로 작동하지 않음

---

## 🏗️ 프로젝트 구조

### 주요 컴포넌트 파일
```
components/
├── CanvasEditor.js              # 기본 캔버스 에디터 (936줄)
├── CanvasEditor_new.js          # 고급 캔버스 에디터 (1054줄) ← 현재 사용 중
├── CanvasEditor_backup.js       # 백업 파일
├── CanvasEditor_fixed.js        # 수정된 버전
├── EventDetailView.js           # 이벤트 상세 뷰 (템플릿 로드 호출)
├── NamecardTemplateManager.js   # 템플릿 관리 컴포넌트
├── NamecardTemplateSettings.js  # 템플릿 설정 컴포넌트
└── PropertyPanel.js             # 속성 패널
```

### 데이터베이스 관련 파일
```
lib/
├── namecardDatabase.js          # 템플릿 CRUD 함수들
├── supabaseClient.js           # Supabase 연결
└── storage.js                  # 이미지 저장
```

### 메모리 뱅크
```
memory_bank/
├── projectbrief.md             # 프로젝트 개요
├── techContext.md              # 기술 스택 정보
├── systemPatterns.md           # 아키텍처 패턴
├── productContext.md           # 비즈니스 로직
└── progress.md                 # 진행 상황
```

---

## 🔍 문제점 상세 분석 (업데이트)

### 1. **배포 환경 캔버스 렌더링 문제**

#### 현재 상황:
- **테스트 환경 (localhost)**: 캔버스 정상 표시 및 작동
- **배포 환경 (Vercel)**: 캔버스가 화면에 렌더링되지 않음
- **데이터 처리**: 프로필 업데이트, 출력 기능은 정상 작동

#### 로그 분석 결과:
```
EventDetailView: Profile change detected: {selectedProfile: '길용석', hasCanvasRef: true, hasUpdateMethod: true}
EventDetailView: Calling updateCanvasWithProfile with: 길용석
Updating canvas with profile: {id: '78d81d3f-752e-4260-9f7e-b467925b31e0', ...}
Current objects count: 3
Text objects found: 3
Text object 0: "에코스솔루션" at position: 170 156
Updated first text to company: 에코스솔루션
Text object 1: "길용석" at position: 170 236
Updated second text to name: 길용석
Text object 2: "대표이사" at position: 170 316
Updated third text to title: 대표이사
Canvas updated with profile data
```

#### 핵심 문제:
- **데이터 처리**: 모든 로직이 정상 작동 (객체 생성, 위치 설정, 텍스트 업데이트)
- **화면 렌더링**: 캔버스가 DOM에 렌더링되지 않음
- **출력 기능**: 정상 작동 (인쇄 미리보기에서 제대로 표시됨)

### 2. **시도한 해결 방법들**

#### A. SSR 문제 해결 시도:
```javascript
// 'use client' 지시어 추가
'use client'

// Fabric.js 동적 import
let fabric = null
const loadFabric = async () => {
  if (typeof window !== 'undefined' && !fabric) {
    const fabricModule = await import('fabric')
    fabric = fabricModule.fabric
  }
  return fabric
}
```

#### B. 강제 렌더링 추가:
```javascript
// 다중 렌더링 시도
canvas.renderAll()
setTimeout(() => canvas.renderAll(), 100)
setTimeout(() => canvas.renderAll(), 300)
setTimeout(() => canvas.renderAll(), 500)
```

#### C. CSS 스타일링 강화:
```javascript
// 캔버스 스타일 명시적 설정
style={{
  width: '340px',
  height: '472px',
  backgroundColor: '#ffffff',
  display: 'block',
  border: '1px solid #e5e7eb',
  borderRadius: '4px',
  boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
  margin: '0 auto'
}}
```

#### D. 재시도 로직 추가:
```javascript
// Fabric.js 로딩 재시도 (최대 5회)
let retryCount = 0
const maxRetries = 5
while (!fabricLib && retryCount < maxRetries) {
  fabricLib = await loadFabric()
  if (!fabricLib) {
    retryCount++
    await new Promise(resolve => setTimeout(resolve, 200 * retryCount))
  }
}
```

#### **결과**: 모든 시도에도 불구하고 배포 환경에서 캔버스가 여전히 표시되지 않음

### 3. **현재 배포 상태**

#### 배포 URL:
- **최신 배포**: https://name-jl2nrdgo8-uslabai.vercel.app
- **검사 URL**: https://vercel.com/uslabai/name-tag/GU1gKhCfnApY5b843Gi3meai7mmp

#### 커밋 히스토리:
1. `2c70b7e` - "Update CanvasEditor with enhanced features and optimizations"
2. `2eda272` - "Fix Fabric.js SSR issue - Add 'use client' directive and dynamic import"
3. `b51d2e5` - "Fix canvas rendering in production - Add retry logic and force rendering"

#### 현재 파일 상태:
- **메인 캔버스**: `components/CanvasEditor_new.js` (1867줄)
- **SSR 대응**: 'use client' 지시어 추가
- **동적 로딩**: Fabric.js 비동기 import 구현
- **강제 렌더링**: 다중 렌더링 시도 로직 추가

---

## 🐛 구체적인 버그들 (업데이트)

### 1. **배포 환경 렌더링 문제**
- **증상**: 테스트 환경에서는 정상 작동하지만 배포 환경에서 캔버스가 화면에 표시되지 않음
- **원인**: Next.js 프로덕션 빌드와 Vercel 배포 환경의 차이점
- **영향**: 사용자가 웹에서 명찰을 편집할 수 없음

### 2. **Fabric.js 로딩 타이밍 문제**
- **증상**: Fabric.js가 로드되기 전에 캔버스 초기화 시도
- **시도한 해결책**: 동적 import, 재시도 로직, 비동기 대기
- **결과**: 여전히 해결되지 않음

### 3. **CSS 렌더링 문제**
- **증상**: 캔버스 요소가 DOM에 존재하지만 화면에 렌더링되지 않음
- **시도한 해결책**: 명시적 CSS 스타일 설정, display: block 강제 설정
- **결과**: 여전히 해결되지 않음

### 4. **데이터 처리 vs 화면 렌더링 불일치**
- **증상**: 모든 데이터 처리 로직은 정상 작동하지만 화면에 반영되지 않음
- **로그 확인**: 프로필 업데이트, 객체 생성, 위치 설정 모두 정상
- **출력 기능**: 인쇄 미리보기에서는 정상적으로 표시됨

### 5. **디버깅 정보 부족**
- **문제**: 배포 환경에서의 구체적인 에러 정보 부족
- **필요**: Vercel 로그 분석, 브라우저 개발자 도구 상세 확인

---

## 🔧 해결 방안 (업데이트)

### 1. **즉시 시도해야 할 방법들**

#### A. Vercel 로그 분석
```bash
# Vercel 로그 확인
npx vercel logs https://name-jl2nrdgo8-uslabai.vercel.app
```

#### B. 브라우저 개발자 도구 상세 분석
- **Console 탭**: JavaScript 에러 확인
- **Network 탭**: Fabric.js 로딩 상태 확인
- **Elements 탭**: 캔버스 DOM 요소 상태 확인
- **Sources 탭**: 소스맵으로 디버깅

#### C. Next.js 빌드 최적화 문제 확인
```javascript
// next.config.js 수정 시도
const nextConfig = {
  images: {
    domains: ['ekmuddykdzebbxmgigif.supabase.co'],
  },
  // Fabric.js 번들링 문제 해결
  webpack: (config) => {
    config.resolve.fallback = {
      ...config.resolve.fallback,
      canvas: false,
    }
    return config
  }
}
```

### 2. **대안 해결 방법들**

#### A. 다른 캔버스 라이브러리 사용
- **Konva.js**: React 친화적, SSR 문제 적음
- **React-Konva**: React 컴포넌트로 캔버스 관리
- **Paper.js**: 벡터 그래픽 라이브러리

#### B. 서버사이드 렌더링 완전 비활성화
```javascript
// dynamic import로 캔버스 컴포넌트 완전 분리
const CanvasEditor = dynamic(() => import('./CanvasEditor_new'), {
  ssr: false,
  loading: () => <div>캔버스 로딩 중...</div>
})
```

#### C. iframe 사용
- 캔버스를 별도 iframe에서 실행하여 DOM 격리
- 메인 앱과 캔버스 간 postMessage 통신

### 3. **디버깅 강화**

#### A. 배포 환경 전용 로깅
```javascript
// 배포 환경에서만 실행되는 디버깅
if (process.env.NODE_ENV === 'production') {
  console.log('Production canvas debug:', {
    fabricLoaded: !!fabric,
    canvasRef: !!canvasRef.current,
    canvasElement: canvasRef.current?.tagName,
    canvasStyle: canvasRef.current?.style.cssText
  })
}
```

#### B. 에러 바운더리 추가
```javascript
// React Error Boundary로 캔버스 에러 캐치
class CanvasErrorBoundary extends React.Component {
  componentDidCatch(error, errorInfo) {
    console.error('Canvas Error:', error, errorInfo)
  }
}
```

---

## 📊 연관 파일 및 의존성

### 직접 연관 파일
1. **components/CanvasEditor_new.js** - 메인 캔버스 에디터
2. **components/EventDetailView.js** - 템플릿 로드 호출
3. **components/NamecardTemplateManager.js** - 템플릿 관리
4. **lib/namecardDatabase.js** - 템플릿 저장/로드 함수

### 간접 연관 파일
1. **components/PropertyPanel.js** - 속성 패널 (템플릿 로드 후 연동)
2. **lib/supabaseClient.js** - 데이터베이스 연결
3. **memory_bank/progress.md** - 진행 상황 기록

### 데이터베이스 테이블
- **namecards** 테이블: 템플릿 데이터 저장
  - `canvas_json` 컬럼: 실제 캔버스 JSON 데이터
  - `template_name`: 템플릿 이름
  - `event_id`: 이벤트 ID

---

## 🎯 우선순위별 해결 계획 (업데이트)

### 1단계: 즉시 디버깅 (High Priority)
- [ ] Vercel 로그 분석하여 구체적인 에러 확인
- [ ] 브라우저 개발자 도구로 상세 분석
- [ ] 배포 환경 전용 디버깅 로그 추가

### 2단계: 대안 시도 (Medium Priority)
- [ ] Next.js webpack 설정 수정
- [ ] dynamic import로 SSR 완전 비활성화
- [ ] 다른 캔버스 라이브러리 검토 (Konva.js, Paper.js)

### 3단계: 근본적 해결 (Low Priority)
- [ ] iframe 기반 캔버스 분리
- [ ] 서버사이드 렌더링 아키텍처 재설계
- [ ] 캔버스 라이브러리 완전 교체

---

## 📝 테스트 시나리오 (업데이트)

### 1. **배포 환경 캔버스 렌더링 테스트**
1. 배포된 웹사이트 접속
2. 브라우저 개발자 도구로 에러 확인
3. 캔버스 DOM 요소 상태 확인
4. Fabric.js 로딩 상태 확인

### 2. **환경별 비교 테스트**
1. localhost (테스트 환경) vs Vercel (배포 환경)
2. 동일한 브라우저에서 두 환경 비교
3. 네트워크 탭에서 리소스 로딩 차이 확인

### 3. **대안 솔루션 테스트**
1. dynamic import로 SSR 비활성화 테스트
2. 다른 캔버스 라이브러리 프로토타입 테스트
3. iframe 기반 캔버스 분리 테스트

---

## 🔍 디버깅을 위한 추가 정보 (업데이트)

### 현재 사용 중인 파일
- **메인 캔버스**: `components/CanvasEditor_new.js` (1867줄)
- **이벤트 뷰**: `components/EventDetailView.js`
- **출력 패널**: `components/OutputPanel.js`
- **데이터베이스**: `lib/namecardDatabase.js`

### 주요 함수들
- `loadFabric()`: Fabric.js 동적 로딩
- `initializeCanvas()`: 캔버스 초기화
- `updateCanvasWithProfile()`: 프로필 업데이트
- `createDefaultTemplate()`: 기본 템플릿 생성

### 배포 환경 디버깅 키워드
- "Loading fabric.js..."
- "Fabric.js loaded successfully"
- "Canvas force rendered after initialization"
- "Canvas updated with profile data"
- "Production canvas debug:"

### 배포 URL 및 상태
- **최신 배포**: https://name-jl2nrdgo8-uslabai.vercel.app
- **Vercel 검사**: https://vercel.com/uslabai/name-tag/GU1gKhCfnApY5b843Gi3meai7mmp
- **GitHub**: https://github.com/ustudiopd/NAME_TAG.git

---

**작성일**: 2025년 1월 13일  
**업데이트**: 2025년 1월 13일 (배포 환경 렌더링 문제 추가)  
**작성자**: Cursor AI Assistant  
**프로젝트**: 명찰 출력 프로그램  
**상태**: 배포 환경 캔버스 렌더링 문제 분석 완료, 대안 해결 방안 제시
