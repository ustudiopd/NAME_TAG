# 텍스트 객체 중복 생성 문제 수정 완료

## 문제점
명찰 편집 화면에서 이름 텍스트가 3개 중첩되어 표시됨

## 원인 분석

1. **`createDefaultTemplate()` 중복 호출**
   - 기본 템플릿 생성 시 기존 텍스트 객체를 제거하지 않고 추가만 함
   - 여러 번 호출되면 같은 dataField를 가진 객체가 중복 생성됨

2. **템플릿 로드 시 기존 객체 미제거**
   - `loadTemplate()`에서 기존 객체를 제거하지 않고 로드
   - 기존 객체와 새로 로드된 객체가 함께 존재

3. **프로필 바인딩 시 중복 체크 없음**
   - 같은 dataField를 가진 객체가 여러 개 있어도 모두 업데이트만 함
   - 중복 객체 제거 로직 없음

## 수정 내용

### 1. `createDefaultTemplate()` 개선
- 기존 텍스트 객체(dataField가 있는)를 먼저 제거
- 중복 생성 방지

```javascript
// 기존 텍스트 객체 제거 (dataField가 있는 텍스트 객체만)
const objects = this.canvas.getObjects()
const textObjectsToRemove = objects.filter(obj => 
  (obj.type === 'i-text' || obj.type === 'text' || obj.type === 'textbox') && 
  obj.dataField
)

if (textObjectsToRemove.length > 0) {
  console.log(`Removing ${textObjectsToRemove.length} existing text objects before creating default template`)
  textObjectsToRemove.forEach(obj => {
    this.canvas.remove(obj)
  })
}
```

### 2. `loadTemplate()` 개선
- 템플릿 로드 전 `canvas.clear()` 호출하여 기존 객체 모두 제거
- 깨끗한 상태에서 템플릿 로드

```javascript
// 기존 객체 모두 제거 (템플릿 로드 전 정리)
this.canvas.clear()

this.canvas.loadFromJSON(canvasJson, () => {
  // ...
})
```

### 3. `bindProfile()` 개선
- 같은 dataField를 가진 객체가 여러 개 있으면 첫 번째만 남기고 나머지 제거
- 중복 객체 자동 정리

```javascript
// 중복 제거: 같은 dataField를 가진 객체가 여러 개 있으면 첫 번째만 남기고 나머지 제거
const fieldMap = new Map()
textObjects.forEach(obj => {
  const dataField = obj.dataField
  if (fieldMap.has(dataField)) {
    // 이미 같은 dataField를 가진 객체가 있으면 제거
    console.log(`Removing duplicate text object with dataField: ${dataField}`)
    this.canvas.remove(obj)
  } else {
    fieldMap.set(dataField, obj)
  }
})
```

## 수정된 파일

- `lib/editor/EditorCore.js`
  - `createDefaultTemplate()`: 기존 텍스트 객체 제거 로직 추가
  - `loadTemplate()`: `canvas.clear()` 호출 추가
  - `bindProfile()`: 중복 객체 제거 로직 추가

## 테스트 방법

1. 브라우저 강력 새로고침 (Ctrl+F5)
2. 편집 화면 접속
3. 콘솔 확인:
   - "Removing X existing text objects before creating default template" 메시지 확인
   - "Removing duplicate text object with dataField: name" 메시지 확인 (중복이 있으면)
4. 화면 확인:
   - 이름 텍스트가 1개만 표시되는지 확인
   - 회사명, 이름, 직급이 각각 1개씩만 표시되는지 확인
5. 프로필 변경 테스트:
   - 다른 프로필 선택 시 텍스트가 정상적으로 업데이트되는지 확인
   - 중복 객체가 생성되지 않는지 확인

## 예상 결과

- ✅ 이름 텍스트가 1개만 표시됨
- ✅ 회사명, 이름, 직급이 각각 1개씩만 표시됨
- ✅ 프로필 변경 시 중복 객체 생성 없음
- ✅ 템플릿 로드 시 기존 객체가 제거되고 새 템플릿만 표시됨

---

**수정 완료일**: 2025-01-27  
**수정된 파일**: `lib/editor/EditorCore.js`

